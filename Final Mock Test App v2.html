<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mock Test Application with Admin Interface</title>
  <style>
    /* Global Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #f0f0f0;
      background-color: #222;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    header {
      background-color: #333;
      color: #fff;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
    
    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 1rem;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      background-color: #333;
      color: #fff;
      border: none;
      margin-right: 0.25rem;
      border-radius: 5px 5px 0 0;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      background-color: #4CAF50;
      font-weight: bold;
    }
    
    .tab:hover:not(.active) {
      background-color: #555;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #333;
      color: #fff;
      box-sizing: border-box;
    }
    
    .btn {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-secondary {
      background-color: #555;
      color: white;
    }
    
    .btn-danger {
      background-color: #f44336;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.85;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* Sections */
    section {
      margin-bottom: 2rem;
      background-color: #333;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    section h2 {
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 0.5rem;
      margin-top: 0;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      background-color: #2a2a2a;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    
    table th,
    table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    
    table th {
      background-color: #222;
      color: white;
      letter-spacing: 0.03em;
    }
    
    table tr:nth-child(even) {
      background-color: #2d2d2d;
    }
    
    table tr:hover {
      background-color: #3a3a3a;
    }
    
    /* Paper Buttons */
    .paper-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .paper-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .paper-btn:hover {
      background-color: #0b7dda;
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* Test Interface */
    .question {
      background-color: #2a2a2a;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    
    .question-number {
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 0.5rem;
    }
    
    .options {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    
    .option {
      padding: 0.5rem;
      background-color: #333;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
    }
    
    .option:hover {
      background-color: #444;
    }
    
    .option input {
      margin-right: 0.5rem;
    }
    
    /* Timer */
    #timerDisplay {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ff9800;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    /* Admin Specific */
    .admin-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stats-card {
      background-color: #2a2a2a;
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0.5rem 0;
      color: #4CAF50;
    }
    
    .stats-title {
      font-size: 1rem;
      color: #aaa;
      margin: 0;
    }
    
    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow: auto;
    }
    
    .modal-content {
      background-color: #333;
      margin: 10% auto;
      padding: 2rem;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      position: relative;
      animation: modalopen 0.4s;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    
    .close:hover {
      color: #fff;
    }
    
    @keyframes modalopen {
      from {opacity: 0; transform: translateY(-60px);}
      to {opacity: 1; transform: translateY(0);}
    }
    
    /* User Management */
    .user-form {
      background-color: #2a2a2a;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    
    /* Utility Classes */
    .hidden {
      display: none;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-2 {
      margin-top: 2rem;
    }
    
    .justify-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .options {
        grid-template-columns: 1fr;
      }
      
      .admin-dashboard {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 90%;
        margin: 20% auto;
      }
    }
    
    /* Leaderboard Tabs */
    .leaderboard-tabs {
      display: flex;
      border-bottom: 1px solid #444;
      margin-bottom: 1rem;
    }
    
    .leaderboard-tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      background-color: transparent;
      border: none;
      color: #ddd;
    }
    
    .leaderboard-tab.active {
      color: #4CAF50;
      font-weight: bold;
      border-bottom: 2px solid #4CAF50;
    }
    
    .leaderboard-panel {
      display: none;
    }
    
    .leaderboard-panel.active {
      display: block;
    }
    
    .paper-select {
      margin-bottom: 1rem;
      width: 100%;
      padding: 0.5rem;
      background-color: #333;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Mock Test Application</h1>
    <p id="currentUserDisplay"></p>
  </header>
  
  <main>
    <!-- Authentication Area -->
    <div id="authArea">
      <div class="tabs">
        <button id="loginTab" class="tab active">Login</button>
        <button id="registerTab" class="tab">Register</button>
        <button id="adminLoginTab" class="tab">Admin Login</button>
      </div>
      
      <!-- Login Form -->
      <div id="loginForm" class="auth-form">
        <section>
          <h2>Login to Mock Test</h2>
          <div class="form-group">
            <label for="loginUsername">Username</label>
            <input type="text" id="loginUsername" class="form-control" placeholder="Enter your username">
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
          </div>
          <button class="btn btn-primary" onclick="login()">Login</button>
        </section>
      </div>
      
      <!-- Register Form -->
      <div id="registerForm" class="auth-form hidden">
        <section>
          <h2>Register New Account</h2>
          <div class="form-group">
            <label for="registerFullName">Full Name</label>
            <input type="text" id="registerFullName" class="form-control" placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label for="registerUsername">Username</label>
            <input type="text" id="registerUsername" class="form-control" placeholder="Choose a username">
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <input type="password" id="registerPassword" class="form-control" placeholder="Enter your password">
          </div>
          <div class="form-group">
            <label for="registerConfirmPassword">Confirm Password</label>
            <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirm your password">
          </div>
          <button class="btn btn-primary" onclick="register()">Register</button>
        </section>
      </div>
      
      <!-- Admin Login Form -->
      <div id="adminLoginForm" class="auth-form hidden">
        <section>
          <h2>Admin Login</h2>
          <div class="form-group">
            <label for="adminUsername">Admin Username</label>
            <input type="text" id="adminUsername" class="form-control" placeholder="Enter admin username">
          </div>
          <div class="form-group">
            <label for="adminPassword">Admin Password</label>
            <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
          </div>
          <button class="btn btn-primary" onclick="adminLogin()">Login as Admin</button>
        </section>
      </div>
    </div>
    
    <!-- User Area -->
    <div id="userArea" class="hidden">
      <section id="welcomeArea">
        <h2>Welcome to the Mock Test Portal</h2>
        <p>Please choose a test paper to start attempting:</p>
        <div id="paperButtons" class="paper-buttons"></div>
      </section>
      
      <section id="leaderboardArea" class="hidden">
        <h2>Mock Test Leaderboard</h2>
        
        <div class="leaderboard-tabs">
          <button class="leaderboard-tab active" onclick="switchLeaderboardTab('overall')">Overall Rankings</button>
          <button class="leaderboard-tab" onclick="switchLeaderboardTab('paperwise')">Paper-wise Rankings</button>
        </div>
        
        <div id="overallLeaderboard" class="leaderboard-panel active">
          <table id="overallLeaderboardTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Average Score</th>
                <th>Papers Attempted</th>
                <th>Last Attempt Date</th>
              </tr>
            </thead>
            <tbody>
              <!-- Leaderboard data will be populated here -->
            </tbody>
          </table>
        </div>
        
        <div id="paperwiseLeaderboard" class="leaderboard-panel">
          <select id="leaderboardPaperSelect" class="paper-select" onchange="loadPaperwiseLeaderboard()">
            <!-- Paper options will be populated here -->
          </select>
          
          <table id="paperwiseLeaderboardTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Score</th>
                <th>Percentage</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <!-- Paperwise leaderboard data will be populated here -->
            </tbody>
          </table>
        </div>
        
        <div class="text-center mt-2">
          <button class="btn btn-secondary" onclick="showUserSection('welcomeArea')">Back to Papers</button>
        </div>
      </section>
      
      <section id="testArea" class="hidden">
        <div id="timerDisplay">Time Remaining: 01:45:00</div>
        <h2 id="testPaperTitle">Test Paper</h2>
        
        <div id="questionsContainer">
          <!-- Questions will be populated here -->
        </div>
        
        <div class="text-center mt-2">
          <button class="btn btn-primary" onclick="submitTest()">Submit Test</button>
          <button class="btn btn-secondary" onclick="confirmExitTest()">Exit Test</button>
        </div>
      </section>
      
      <section id="resultArea" class="hidden">
        <h2>Test Results</h2>
        <div id="scoreDisplay" class="text-center" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
          Final Score: 0 / 0
        </div>
        
        <table id="resultTable">
          <thead>
            <tr>
              <th>Question No.</th>
              <th>Question</th>
              <th>Correct Answer</th>
              <th>Your Answer</th>
            </tr>
          </thead>
          <tbody>
            <!-- Results will be populated here -->
          </tbody>
        </table>
        
        <div class="text-center mt-2">
          <button class="btn btn-secondary" onclick="showUserSection('welcomeArea')">Back to Papers</button>
          <button class="btn btn-primary" onclick="showUserSection('leaderboardArea'); loadLeaderboards();">View Leaderboard</button>
        </div>
      </section>
      
      <div class="text-center">
        <button class="btn btn-danger" onclick="logout()">Logout</button>
        <button class="btn btn-secondary" onclick="showUserSection('leaderboardArea'); loadLeaderboards();">View Leaderboard</button>
      </div>
    </div>
    
    <!-- Admin Area -->
    <div id="adminArea" class="hidden">
      <section id="adminNavigation">
        <div class="justify-between">
          <h2>Admin Dashboard</h2>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
        
        <div class="admin-actions">
          <button class="btn btn-primary" onclick="showAdminSection('adminDashboard'); loadAdminDashboard();">Dashboard</button>
          <button class="btn btn-primary" onclick="showAdminSection('adminPapers'); loadPapersList();">Manage Papers</button>
          <button class="btn btn-primary" onclick="showAdminSection('adminUsers'); loadUsersList();">Manage Users</button>
          <button class="btn btn-primary" onclick="showAdminSection('adminUserAttempts'); loadUserAttemptsSelect();">User Attempts</button>
          <button class="btn btn-primary" onclick="showAdminSection('adminSettings');">Settings</button>
        </div>
      </section>
      
      <section id="adminDashboard">
        <h2>System Overview</h2>
        <div class="admin-dashboard">
          <div class="stats-card">
            <h3 class="stats-title">Total Users</h3>
            <div id="totalUsersCount" class="stats-number">0</div>
          </div>
          <div class="stats-card">
            <h3 class="stats-title">Total Papers</h3>
            <div id="totalPapersCount" class="stats-number">0</div>
          </div>
          <div class="stats-card">
            <h3 class="stats-title">Total Test Attempts</h3>
            <div id="totalAttemptsCount" class="stats-number">0</div>
          </div>
          <div class="stats-card">
            <h3 class="stats-title">Average Score</h3>
            <div id="averageScore" class="stats-number">0%</div>
          </div>
        </div>
        
        <h3>Recent Activity</h3>
        <table id="recentActivityTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Paper</th>
              <th>Score</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- Recent activity will be populated here -->
          </tbody>
        </table>
      </section>
      
      <section id="adminPapers" class="hidden">
        <h2>Manage Test Papers</h2>
        
        <table id="papersTable">
          <thead>
            <tr>
              <th>Paper No.</th>
              <th>Questions</th>
              <th>Time Limit</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Papers will be populated here -->
          </tbody>
        </table>
        
        <div class="mt-2">
          <button class="btn btn-danger" onclick="showModal('resetPapersModal')">Reset All Papers to Default</button>
        </div>
      </section>
      
      <div id="editPaperForm" class="hidden">
        <h2 id="editPaperTitle">Edit Paper</h2>
        
        <div class="form-group">
          <label>Time Limit:</label>
          <div style="display: flex; gap: 1rem;">
            <input type="number" id="editPaperHours" class="form-control" placeholder="Hours" min="0" max="5">
            <input type="number" id="editPaperMinutes" class="form-control" placeholder="Minutes" min="0" max="59">
          </div>
        </div>
        
        <div id="editQuestionsContainer">
          <!-- Questions editing interface will be inserted here -->
        </div>
        
        <div class="text-center mt-2">
          <button class="btn btn-primary" onclick="saveEditedPaper()">Save Paper</button>
          <button class="btn btn-secondary" onclick="showAdminSection('adminPapers')">Cancel</button>
        </div>
      </div>
      
      <section id="adminUsers" class="hidden">
        <h2>Manage Users</h2>
        
        <div class="user-form">
          <h3>Add Admin User</h3>
          <div class="form-group">
            <label for="newAdminFullName">Full Name</label>
            <input type="text" id="newAdminFullName" class="form-control" placeholder="Enter full name">
          </div>
          <div class="form-group">
            <label for="newAdminUsername">Username</label>
            <input type="text" id="newAdminUsername" class="form-control" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label for="newAdminPassword">Password</label>
            <input type="password" id="newAdminPassword" class="form-control" placeholder="Enter password">
          </div>
          <button class="btn btn-primary" onclick="addAdminUser()">Add Admin User</button>
        </div>
        
        <h3>User List</h3>
        <table id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Users will be populated here -->
          </tbody>
        </table>
      </section>
      
      <section id="adminUserAttempts" class="hidden">
        <h2>User Test Attempts</h2>
        
        <select id="userAttemptsSelect" class="form-control" onchange="loadAttemptsForUser()">
          <option value="">Select a User</option>
        </select>
        
        <div id="userAttemptsContainer" class="mt-2">
          <p id="noAttemptsMessage">Select a user to view their attempts.</p>
          <table id="userAttemptsTable" class="hidden">
            <thead>
              <tr>
                <th>Paper No.</th>
                <th>Score</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Attempts will be populated here -->
            </tbody>
          </table>
        </div>
      </section>
      
      <section id="adminSettings" class="hidden">
        <h2>Admin Settings</h2>
        
        <div class="stats-card">
          <h3>Data Management</h3>
          <div class="mt-2">
            <button class="btn btn-danger" onclick="showModal('deleteAllDataModal')">Delete All User Data</button>
            <button class="btn btn-danger" onclick="showModal('resetAttemptsModal')">Clear All Attempts</button>
            <button class="btn btn-danger" onclick="showModal('resetPapersModal')">Reset Papers to Default</button>
            <button class="btn btn-danger" onclick="showModal('factoryResetModal')">Factory Reset</button>
          </div>
        </div>
        
        <div class="stats-card mt-2">
          <h3>Data Export</h3>
          <div class="mt-2">
            <button class="btn btn-secondary" onclick="exportUserData()">Export User Data</button>
            <button class="btn btn-secondary" onclick="exportAttemptData()">Export Attempt Data</button>
            <button class="btn btn-secondary" onclick="exportPaperData()">Export Paper Data</button>
          </div>
        </div>
      </section>
    </div>
    
    <!-- Modals -->
    <div id="deleteAllDataModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('deleteAllDataModal')">&times;</span>
        <h2>Confirm Delete All User Data</h2>
        <p>This will permanently delete all user accounts except admin accounts. This action cannot be undone.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="deleteAllUserData()">Delete All Users</button>
          <button class="btn btn-secondary" onclick="closeModal('deleteAllDataModal')">Cancel</button>
        </div>
      </div>
    </div>
    
    <div id="resetAttemptsModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('resetAttemptsModal')">&times;</span>
        <h2>Confirm Clear All Attempts</h2>
        <p>This will permanently delete all test attempts and leaderboards. This action cannot be undone.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="clearAllAttempts()">Clear All Attempts</button>
          <button class="btn btn-secondary" onclick="closeModal('resetAttemptsModal')">Cancel</button>
        </div>
      </div>
    </div>
    
    <div id="resetPapersModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('resetPapersModal')">&times;</span>
        <h2>Confirm Reset Papers</h2>
        <p>This will reset all test papers to default. All custom questions and answer keys will be lost. This action cannot be undone.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="resetPapers()">Reset Papers</button>
          <button class="btn btn-secondary" onclick="closeModal('resetPapersModal')">Cancel</button>
        </div>
      </div>
    </div>
    
    <div id="factoryResetModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('factoryResetModal')">&times;</span>
        <h2>Confirm Factory Reset</h2>
        <p>This will delete all user data, all test attempts, and reset all papers to default. Only the default admin account will remain. This action cannot be undone.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="factoryReset()">Factory Reset</button>
          <button class="btn btn-secondary" onclick="closeModal('factoryResetModal')">Cancel</button>
        </div>
      </div>
    </div>
    
    <div id="exitTestModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('exitTestModal')">&times;</span>
        <h2>Confirm Exit Test</h2>
        <p>Are you sure you want to exit the test? Your progress will be lost.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="exitTest()">Exit Test</button>
          <button class="btn btn-secondary" onclick="closeModal('exitTestModal')">Continue Test</button>
        </div>
      </div>
    </div>
    
    <div id="viewUserAttemptModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('viewUserAttemptModal')">&times;</span>
        <h2>Test Attempt Details</h2>
        <div id="attemptDetailsContainer">
          <!-- Attempt details will be populated here -->
        </div>
        <div class="text-center mt-2">
          <button class="btn btn-secondary" onclick="closeModal('viewUserAttemptModal')">Close</button>
        </div>
      </div>
    </div>
    
    <div id="deleteUserModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('deleteUserModal')">&times;</span>
        <h2>Confirm Delete User</h2>
        <p>Are you sure you want to delete this user? All their test attempts will also be deleted.</p>
        <div class="text-center mt-2">
          <button class="btn btn-danger" onclick="confirmDeleteUser()">Delete User</button>
          <button class="btn btn-secondary" onclick="closeModal('deleteUserModal')">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Global variables
    let currentUser = null;
    let users = [];
    let papers = [];
    let attempts = [];
    let currentPaper = null;
    let currentQuestions = [];
    let currentAnswerKey = "";
    let totalQuestions = 0;
    let timerInterval = null;
    let timeRemaining = 0;
    let userToDelete = null;
    
    // Default number of papers (35)
    const defaultTotalPapers = 35;
    
    // Default admin credentials
    const defaultAdminUsername = "admin";
    const defaultAdminPassword = "admin123";
    
    // Initialize the application
    document.addEventListener("DOMContentLoaded", function() {
      initializeApp();
      setupEventListeners();
    });
    
    function initializeApp() {
      initializeUsers();
      initializePapers();
      initializeAttempts();
      
      // Check if user is already logged in
      const storedUser = localStorage.getItem("currentUser");
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        if (currentUser.role === "admin") {
          showAdminInterface();
          loadAdminDashboard();
        } else {
          showUserInterface();
        }
      }
      
      // If not logged in, show auth area
      if (!currentUser) {
        document.getElementById("authArea").classList.remove("hidden");
      }
    }
    
    function setupEventListeners() {
      // Auth tabs
      document.getElementById("loginTab").addEventListener("click", function() {
        showAuthForm("loginForm");
        document.getElementById("loginTab").classList.add("active");
        document.getElementById("registerTab").classList.remove("active");
        document.getElementById("adminLoginTab").classList.remove("active");
      });
      
      document.getElementById("registerTab").addEventListener("click", function() {
        showAuthForm("registerForm");
        document.getElementById("loginTab").classList.remove("active");
        document.getElementById("registerTab").classList.add("active");
        document.getElementById("adminLoginTab").classList.remove("active");
      });
      
      document.getElementById("adminLoginTab").addEventListener("click", function() {
        showAuthForm("adminLoginForm");
        document.getElementById("loginTab").classList.remove("active");
        document.getElementById("registerTab").classList.remove("active");
        document.getElementById("adminLoginTab").classList.add("active");
      });
      
      // Close modal when clicking outside
      window.onclick = function(event) {
        const modals = document.getElementsByClassName("modal");
        for (let modal of modals) {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        }
      };
    }
    
    // Initialize users
    function initializeUsers() {
      let storedUsers = localStorage.getItem("users");
      if (storedUsers) {
        users = JSON.parse(storedUsers);
        return;
      }
      
      // Create default admin user if no users exist
      users = [
        {
          fullName: "Admin User",
          username: defaultAdminUsername,
          password: defaultAdminPassword,
          role: "admin"
        }
      ];
      localStorage.setItem("users", JSON.stringify(users));
    }
    
    // Initialize papers
    function initializePapers() {
      let storedPapers = localStorage.getItem("papers");
      if (storedPapers) {
        const papers = JSON.parse(storedPapers);
        
        // Upgrade existing papers to include options if they don't have them
        papers.forEach(paper => {
          if (!Array.isArray(paper.questions)) return;
          
          // Convert simple string questions to objects with options
          paper.questions = paper.questions.map(q => {
            if (typeof q === 'string') {
              return {
                text: q,
                options: {
                  A: '',
                  B: '',
                  C: '',
                  D: ''
                }
              };
            }
            return q;
          });
        });
        
        localStorage.setItem("papers", JSON.stringify(papers));
        return papers;
      }
      
      // Create default papers if not exists
      papers = [];
      for(let i = 1; i <= defaultTotalPapers; i++) {
        // For paper 35, set only 35 questions, others get 100
        const questionCount = i === 35 ? 35 : 100;
        
        papers.push({ 
          paperNo: i, 
          questionCount: questionCount,
          questions: generateRandomQuestions(questionCount),
          timeLimit: 105 * 60 // 1 hour 45 minutes in seconds
        });
        
        // Generate and save random answer key
        const answerKey = generateRandomAnswerKey(questionCount);
        localStorage.setItem("key_paper_" + i, answerKey);
      }
      
      localStorage.setItem("papers", JSON.stringify(papers));
      return papers;
    }
    
    // Initialize attempts
    function initializeAttempts() {
      let storedAttempts = localStorage.getItem("attempts");
      if (storedAttempts) {
        attempts = JSON.parse(storedAttempts);
      } else {
        attempts = [];
        localStorage.setItem("attempts", JSON.stringify(attempts));
      }
    }
    
    // Generate random questions with options
    function generateRandomQuestions(count) {
      let questions = [];
      for(let i = 1; i <= count; i++) {
        questions.push({
          text: `Question ${i}`,
          options: {
            A: '',
            B: '',
            C: '',
            D: ''
          }
        });
      }
      return questions;
    }
    
    // Generate random answer key
    function generateRandomAnswerKey(count) {
      const options = ['A', 'B', 'C', 'D'];
      let key = '';
      for(let i = 0; i < count; i++) {
        key += options[Math.floor(Math.random() * options.length)];
      }
      return key;
    }
    
    // Get answer key for a paper
    function getAnswerKeyForPaper(paperNo) {
      const key = localStorage.getItem("key_paper_" + paperNo);
      return key || generateRandomAnswerKey(100);
    }
    
    // Authentication Functions
    function showAuthForm(formId) {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("registerForm").classList.add("hidden");
      document.getElementById("adminLoginForm").classList.add("hidden");
      document.getElementById(formId).classList.remove("hidden");
    }
    
    function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      
      if (!username || !password) {
        alert("Please enter both username and password");
        return;
      }
      
      const user = users.find(u => u.username === username && u.password === password && u.role !== "admin");
      if (user) {
        currentUser = user;
        localStorage.setItem("currentUser", JSON.stringify(user));
        showUserInterface();
        loadPaperButtons();
      } else {
        alert("Invalid username or password");
      }
    }
    
    function register() {
      const fullName = document.getElementById("registerFullName").value.trim();
      const username = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value.trim();
      const confirmPassword = document.getElementById("registerConfirmPassword").value.trim();
      
      if (!fullName || !username || !password || !confirmPassword) {
        alert("Please fill in all fields");
        return;
      }
      
      if (password !== confirmPassword) {
        alert("Passwords do not match");
        return;
      }
      
      if (users.some(u => u.username === username)) {
        alert("Username already exists. Please choose another username.");
        return;
      }
      
      const newUser = {
        fullName: fullName,
        username: username,
        password: password,
        role: "user"
      };
      
      users.push(newUser);
      localStorage.setItem("users", JSON.stringify(users));
      
      currentUser = newUser;
      localStorage.setItem("currentUser", JSON.stringify(newUser));
      
      alert("Registration successful!");
      showUserInterface();
      loadPaperButtons();
    }
    
    function adminLogin() {
      const username = document.getElementById("adminUsername").value.trim();
      const password = document.getElementById("adminPassword").value.trim();
      
      if (!username || !password) {
        alert("Please enter both username and password");
        return;
      }
      
      const admin = users.find(u => u.username === username && u.password === password && u.role === "admin");
      if (admin) {
        currentUser = admin;
        localStorage.setItem("currentUser", JSON.stringify(admin));
        showAdminInterface();
        loadAdminDashboard();
      } else {
        alert("Invalid admin credentials");
      }
    }
    
    function logout() {
      currentUser = null;
      localStorage.removeItem("currentUser");
      
      // Hide user and admin areas
      document.getElementById("userArea").classList.add("hidden");
      document.getElementById("adminArea").classList.add("hidden");
      document.getElementById("authArea").classList.remove("hidden");
      document.getElementById("loginTab").click();
      
      // Clear inputs
      document.getElementById("loginUsername").value = "";
      document.getElementById("loginPassword").value = "";
      document.getElementById("registerFullName").value = "";
      document.getElementById("registerUsername").value = "";
      document.getElementById("registerPassword").value = "";
      document.getElementById("registerConfirmPassword").value = "";
      document.getElementById("adminUsername").value = "";
      document.getElementById("adminPassword").value = "";
    }
    
    // User Interface Functions
    function showUserInterface() {
      document.getElementById("authArea").classList.add("hidden");
      document.getElementById("adminArea").classList.add("hidden");
      document.getElementById("userArea").classList.remove("hidden");
      
      document.getElementById("currentUserDisplay").innerText = "Logged in as: " + currentUser.fullName;
      
      // Show welcome area and hide others
      showUserSection("welcomeArea");
      loadPaperButtons();
    }
    
    function showUserSection(sectionId) {
      const sections = ["welcomeArea", "testArea", "resultArea", "leaderboardArea"];
      sections.forEach(section => {
        document.getElementById(section).classList.add("hidden");
      });
      document.getElementById(sectionId).classList.remove("hidden");
    }
    
    function loadPaperButtons() {
      const container = document.getElementById("paperButtons");
      container.innerHTML = "";
      
      // Get papers from localStorage
      const storedPapers = localStorage.getItem("papers");
      if (storedPapers) {
        papers = JSON.parse(storedPapers);
      }
      
      papers.forEach(paper => {
        const button = document.createElement("div");
        button.className = "paper-btn";
        button.innerText = "Paper " + paper.paperNo;
        button.onclick = function() { startTest(paper.paperNo); };
        container.appendChild(button);
      });
    }
    
    function startTest(paperNo) {
      const paper = papers.find(p => p.paperNo === parseInt(paperNo));
      if (!paper) {
        alert("Paper not found!");
        return;
      }
      
      currentPaper = paperNo;
      totalQuestions = paper.questionCount;
      
      // Get current questions
      currentQuestions = paper.questions;
      
      // Get answer key
      currentAnswerKey = getAnswerKeyForPaper(paperNo);
      
      // Set paper title
      document.getElementById("testPaperTitle").innerText = "Test Paper " + paperNo;
      
      // Generate questions
      generateQuestions();
      
      // Set up timer
      timeRemaining = paper.timeLimit; // in seconds
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
      
      // Show test area
      showUserSection("testArea");
    }
    
    function generateQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      
      const paper = papers.find(p => p.paperNo === parseInt(currentPaper));
      if (!paper) return;
      
      for(let i = 1; i <= totalQuestions; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        // Get question and options
        const question = currentQuestions[i-1];
        const questionText = typeof question === 'string' ? question : question.text;
        const options = typeof question === 'string' ? { A: '', B: '', C: '', D: '' } : (question.options || { A: '', B: '', C: '', D: '' });
        
        // Add question number
        const questionNumberDiv = document.createElement('div');
        questionNumberDiv.className = 'question-number';
        questionNumberDiv.innerText = 'Question ' + i;
        questionDiv.appendChild(questionNumberDiv);
        
        // Add question text
        const questionTextDiv = document.createElement('div');
        questionTextDiv.className = 'question-text';
        questionTextDiv.innerText = questionText;
        questionDiv.appendChild(questionTextDiv);
        
        // Add options container
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        // Add options A, B, C, D with custom text if available
        ['A', 'B', 'C', 'D'].forEach(option => {
          const label = document.createElement('label');
          label.className = 'option';
          const optionText = options[option] ? ` ${options[option]}` : '';
          label.innerHTML = `<input type="radio" name="q${i}" value="${option}"> ${option}${optionText}`;
          optionsDiv.appendChild(label);
        });
        
        questionDiv.appendChild(optionsDiv);
        container.appendChild(questionDiv);
      }
    }
    
    function updateTimer() {
      timeRemaining--;
      
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        alert("Time's up! Submitting your test...");
        submitTest();
        return;
      }
      
      const hours = Math.floor(timeRemaining / 3600);
      const minutes = Math.floor((timeRemaining % 3600) / 60);
      const seconds = timeRemaining % 60;
      
      const formattedHours = String(hours).padStart(2, '0');
      const formattedMinutes = String(minutes).padStart(2, '0');
      const formattedSeconds = String(seconds).padStart(2, '0');
      
      document.getElementById("timerDisplay").innerText = 
        `Time Remaining: ${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
    }
    
    function submitTest() {
      clearInterval(timerInterval);
      
      const resultArea = document.getElementById('resultArea');
      const resultTableBody = document.getElementById('resultTable').getElementsByTagName('tbody')[0];
      resultTableBody.innerHTML = '';
      
      let score = 0;
      let attemptDetails = [];
      
      for(let i = 1; i <= totalQuestions; i++){
        const radios = document.getElementsByName('q' + i);
        let userAnswer = '';
        for(let radio of radios) {
          if (radio.checked) {
            userAnswer = radio.value;
            break;
          }
        }
        
        const correctAnswer = currentAnswerKey[i-1];
        if (userAnswer === correctAnswer) {
          score += 2;
        }
        
        // Get question and options
        const question = currentQuestions[i-1];
        const questionText = typeof question === 'string' ? question : question.text;
        const options = typeof question === 'string' ? { A: '', B: '', C: '', D: '' } : (question.options || { A: '', B: '', C: '', D: '' });
        
        attemptDetails.push({ 
          question: i, 
          questionText: questionText,
          correct: correctAnswer, 
          user: userAnswer || 'Not Answered' 
        });
        
        const correctOptionText = options[correctAnswer] ? ` (${options[correctAnswer]})` : '';
        const userOptionText = userAnswer && options[userAnswer] ? ` (${options[userAnswer]})` : '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i}</td>
          <td>${questionText}</td>
          <td>${correctAnswer}${correctOptionText}</td>
          <td>${userAnswer || 'Not Answered'}${userOptionText}</td>
        `;
        resultTableBody.appendChild(row);
      }
      
      document.getElementById('scoreDisplay').innerText = 'Final Score: ' + score + ' / ' + (totalQuestions * 2);
      showUserSection('resultArea');
      
      // Save attempt in localStorage
      saveAttempt({
        id: generateUID(),
        name: currentUser.fullName,
        username: currentUser.username,
        paper: currentPaper,
        score: score,
        total: totalQuestions * 2,
        date: new Date().toLocaleString(),
        details: attemptDetails
      });
    }
    
    function saveAttempt(attempt) {
      attempts.push(attempt);
      localStorage.setItem("attempts", JSON.stringify(attempts));
    }
    
    function confirmExitTest() {
      showModal('exitTestModal');
    }
    
    function exitTest() {
      clearInterval(timerInterval);
      closeModal('exitTestModal');
      showUserSection('welcomeArea');
    }
    
    // Leaderboard Functions
    function loadLeaderboards() {
      loadOverallLeaderboard();
      loadPaperwiseLeaderboardSelect();
    }
    
    function loadOverallLeaderboard() {
      const tbody = document.getElementById("overallLeaderboardTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      
      // Process attempts by user
      const userStats = {};
      attempts.forEach(attempt => {
        if (!userStats[attempt.username]) {
          userStats[attempt.username] = {
            name: attempt.name,
            totalScore: 0,
            totalPossible: 0,
            count: 0,
            lastDate: new Date(0)
          };
        }
        
        userStats[attempt.username].totalScore += attempt.score;
        userStats[attempt.username].totalPossible += attempt.total;
        userStats[attempt.username].count++;
        
        const attemptDate = new Date(attempt.date);
        if (attemptDate > userStats[attempt.username].lastDate) {
          userStats[attempt.username].lastDate = attemptDate;
        }
      });
      
      // Convert to array for sorting
      let leaderboardData = Object.keys(userStats).map(username => {
        const stats = userStats[username];
        return {
          name: stats.name,
          username: username,
          avgScore: (stats.totalScore / stats.totalPossible * 100).toFixed(2),
          count: stats.count,
          lastDate: stats.lastDate
        };
      });
      
      // Sort by average score
      leaderboardData.sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore));
      
      // Display leaderboard
      leaderboardData.forEach((user, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.name}</td>
          <td>${user.avgScore}%</td>
          <td>${user.count}</td>
          <td>${user.lastDate.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
      
      // If no data
      if (leaderboardData.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5" class="text-center">No data available</td>`;
        tbody.appendChild(row);
      }
    }
    
    function loadPaperwiseLeaderboardSelect() {
      const select = document.getElementById("leaderboardPaperSelect");
      select.innerHTML = "";
      
      // Get unique paper numbers from attempts
      const uniquePapers = [...new Set(attempts.map(a => a.paper))];
      uniquePapers.sort((a, b) => a - b);
      
      uniquePapers.forEach(paperNo => {
        const option = document.createElement("option");
        option.value = paperNo;
        option.text = "Paper " + paperNo;
        select.appendChild(option);
      });
      
      // If papers exist, load leaderboard for first paper
      if (uniquePapers.length > 0) {
        select.value = uniquePapers[0];
        loadPaperwiseLeaderboard();
      } else {
        const tbody = document.getElementById("paperwiseLeaderboardTable").getElementsByTagName("tbody")[0];
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">No data available</td></tr>`;
      }
    }
    
    function loadPaperwiseLeaderboard() {
      const selectedPaper = document.getElementById("leaderboardPaperSelect").value;
      const tbody = document.getElementById("paperwiseLeaderboardTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      
      if (!selectedPaper) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">Select a paper</td></tr>`;
        return;
      }
      
      // Filter attempts by selected paper
      const paperAttempts = attempts.filter(a => a.paper == selectedPaper);
      
      // For each user, get their best attempt on this paper
      const userBestAttempts = {};
      paperAttempts.forEach(attempt => {
        const username = attempt.username;
        if (!userBestAttempts[username] || attempt.score > userBestAttempts[username].score) {
          userBestAttempts[username] = attempt;
        }
      });
      
      // Convert to array for sorting
      let leaderboardData = Object.values(userBestAttempts);
      
      // Sort by score
      leaderboardData.sort((a, b) => b.score - a.score);
      
      // Display leaderboard
      leaderboardData.forEach((attempt, index) => {
        const percentage = (attempt.score / attempt.total * 100).toFixed(2);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${attempt.name}</td>
          <td>${attempt.score} / ${attempt.total}</td>
          <td>${percentage}%</td>
          <td>${new Date(attempt.date).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
      
      // If no data
      if (leaderboardData.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5" class="text-center">No attempts for this paper</td>`;
        tbody.appendChild(row);
      }
    }
    
    function switchLeaderboardTab(tabId) {
      const tabs = document.getElementsByClassName("leaderboard-tab");
      const panels = document.getElementsByClassName("leaderboard-panel");
      
      // Hide all panels
      for(let panel of panels) {
        panel.classList.remove("active");
      }
      
      // Deactivate all tabs
      for(let tab of tabs) {
        tab.classList.remove("active");
      }
      
      // Activate selected tab and panel
      document.getElementById(tabId + "Leaderboard").classList.add("active");
      document.querySelector(`.leaderboard-tab[onclick="switchLeaderboardTab('${tabId}')"]`).classList.add("active");
    }
    
    // Admin Interface Functions
    function showAdminInterface() {
      document.getElementById("authArea").classList.add("hidden");
      document.getElementById("userArea").classList.add("hidden");
      document.getElementById("adminArea").classList.remove("hidden");
      
      document.getElementById("currentUserDisplay").innerText = "Admin Panel: " + currentUser.fullName;
    }
    
    function showAdminSection(sectionId) {
      const sections = ["adminDashboard", "adminPapers", "adminUsers", "adminUserAttempts", "adminSettings", "editPaperForm"];
      sections.forEach(section => {
        document.getElementById(section).classList.add("hidden");
      });
      document.getElementById(sectionId).classList.remove("hidden");
    }
    
    function loadAdminDashboard() {
      // Load papers and users data
      const storedPapers = localStorage.getItem("papers");
      const storedUsers = localStorage.getItem("users");
      const storedAttempts = localStorage.getItem("attempts");
      
      papers = storedPapers ? JSON.parse(storedPapers) : [];
      users = storedUsers ? JSON.parse(storedUsers) : [];
      attempts = storedAttempts ? JSON.parse(storedAttempts) : [];
      
      // Count regular users (not admins)
      const userCount = users.filter(u => u.role !== "admin").length;
      
      // Update dashboard statistics
      document.getElementById("totalUsersCount").innerText = userCount;
      document.getElementById("totalPapersCount").innerText = papers.length;
      document.getElementById("totalAttemptsCount").innerText = attempts.length;
      
      // Calculate average score
      if (attempts.length > 0) {
        const totalScorePercentage = attempts.reduce((total, attempt) => {
          return total + (attempt.score / attempt.total * 100);
        }, 0);
        const avgScore = (totalScorePercentage / attempts.length).toFixed(2);
        document.getElementById("averageScore").innerText = avgScore + "%";
      } else {
        document.getElementById("averageScore").innerText = "0%";
      }
      
      // Show recent activity
      const recentActivityTable = document.getElementById("recentActivityTable").getElementsByTagName("tbody")[0];
      recentActivityTable.innerHTML = "";
      
      // Sort attempts by date (most recent first)
      const sortedAttempts = [...attempts].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });
      
      // Show only the 10 most recent attempts
      const recentAttempts = sortedAttempts.slice(0, 10);
      
      recentAttempts.forEach(attempt => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${attempt.name}</td>
          <td>Paper ${attempt.paper}</td>
          <td>${attempt.score} / ${attempt.total} (${(attempt.score/attempt.total*100).toFixed(2)}%)</td>
          <td>${new Date(attempt.date).toLocaleString()}</td>
        `;
        recentActivityTable.appendChild(row);
      });
      
      // If no recent activity
      if (recentAttempts.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="4" class="text-center">No recent activity</td>`;
        recentActivityTable.appendChild(row);
      }
    }
    
    function loadPapersList() {
      const storedPapers = localStorage.getItem("papers");
      papers = storedPapers ? JSON.parse(storedPapers) : [];
      
      const tbody = document.getElementById("papersTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      
      papers.forEach(paper => {
        const timeInMinutes = Math.floor(paper.timeLimit / 60);
        const hours = Math.floor(timeInMinutes / 60);
        const minutes = timeInMinutes % 60;
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${paper.paperNo}</td>
          <td>${paper.questionCount}</td>
          <td>${hours}h ${minutes}m</td>
          <td>
            <button class="btn btn-primary" onclick="editPaper(${paper.paperNo})">Edit</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function editPaper(paperNo) {
      const paper = papers.find(p => p.paperNo === parseInt(paperNo));
      if (!paper) {
        alert("Paper not found!");
        return;
      }
      
      currentPaper = paperNo;
      
      // Get questions and answer key
      const totalQuestions = paper.questionCount;
      const currentQuestions = paper.questions;
      const answerKey = getAnswerKeyForPaper(paperNo);
      
      // Set the timer inputs
      const hours = Math.floor(paper.timeLimit / 3600);
      const minutes = Math.floor((paper.timeLimit % 3600) / 60);
      document.getElementById('editPaperHours').value = hours;
      document.getElementById('editPaperMinutes').value = minutes;
      
      document.getElementById('editPaperTitle').innerText = 'Edit Paper ' + paperNo;
      const container = document.getElementById('editQuestionsContainer');
      container.innerHTML = '';
      
      // Create instructions
      const instructions = document.createElement('div');
      instructions.innerHTML = `
        <p style="margin: 20px 0;">Edit questions, options and answer keys below:</p>
      `;
      container.appendChild(instructions);
      
      // Create editable table
      const table = document.createElement('table');
      table.id = 'editQuestionsTable';
      table.style.width = '100%';
      table.style.marginTop = '20px';
      
      // Create table header with option columns
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th width="5%">Q. No.</th>
          <th width="35%">Question</th>
          <th width="12%">Option A</th>
          <th width="12%">Option B</th>
          <th width="12%">Option C</th>
          <th width="12%">Option D</th>
          <th width="12%">Key (A/B/C/D)</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement('tbody');
      for(let i = 0; i < totalQuestions; i++) {
        const row = document.createElement('tr');
        
        // Get question and options
        const question = currentQuestions[i] || { text: `Question ${i+1}`, options: { A: '', B: '', C: '', D: '' } };
        const questionText = typeof question === 'string' ? question : question.text;
        const options = typeof question === 'string' ? { A: '', B: '', C: '', D: '' } : (question.options || { A: '', B: '', C: '', D: '' });
        
        row.innerHTML = `
          <td>${i+1}</td>
          <td contenteditable="true">${questionText}</td>
          <td contenteditable="true">${options.A || ''}</td>
          <td contenteditable="true">${options.B || ''}</td>
          <td contenteditable="true">${options.C || ''}</td>
          <td contenteditable="true">${options.D || ''}</td>
          <td contenteditable="true">${answerKey[i] || 'A'}</td>
        `;
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      
      container.appendChild(table);
      document.getElementById('editPaperForm').classList.remove('hidden');
    }
    
    function saveEditedPaper() {
      const paper = papers.find(p => p.paperNo === parseInt(currentPaper));
      if (!paper) {
        alert("Paper not found!");
        return;
      }
      
      const table = document.getElementById('editQuestionsTable');
      const tbody = table.getElementsByTagName('tbody')[0];
      const rows = tbody.rows;
      
      // Update questions and build answer key
      let updatedQuestions = [];
      let answerKey = '';
      
      for(let i = 0; i < rows.length; i++) {
        const questionText = rows[i].cells[1].textContent.trim();
        const optionA = rows[i].cells[2].textContent.trim();
        const optionB = rows[i].cells[3].textContent.trim();
        const optionC = rows[i].cells[4].textContent.trim();
        const optionD = rows[i].cells[5].textContent.trim();
        let keyValue = rows[i].cells[6].textContent.trim().toUpperCase();
        
        // Validate key value (must be A, B, C, D)
        if (!['A', 'B', 'C', 'D'].includes(keyValue)) {
          alert(`Invalid answer key "${keyValue}" at question ${i+1}. Must be A, B, C, or D.`);
          return;
        }
        
        // Save question with options
        updatedQuestions.push({
          text: questionText,
          options: {
            A: optionA,
            B: optionB,
            C: optionC,
            D: optionD
          }
        });
        
        answerKey += keyValue;
      }
      
      // Save updated questions
      paper.questions = updatedQuestions;
      localStorage.setItem("papers", JSON.stringify(papers));
      
      // Save answer key
      localStorage.setItem("key_paper_" + currentPaper, answerKey);
      
      // Update the timer as well
      updatePaperTimer();
      
      alert("Paper updated successfully!");
      showAdminSection('adminPapers');
    }
    
    function updatePaperTimer() {
      const paper = papers.find(p => p.paperNo === parseInt(currentPaper));
      if (!paper) return;
      
      const hours = parseInt(document.getElementById('editPaperHours').value) || 0;
      const minutes = parseInt(document.getElementById('editPaperMinutes').value) || 0;
      
      const timeInSeconds = (hours * 3600) + (minutes * 60);
      paper.timeLimit = timeInSeconds > 0 ? timeInSeconds : 6300; // Default to 1h45m
      
      localStorage.setItem("papers", JSON.stringify(papers));
    }
    
    function loadUsersList() {
      const storedUsers = localStorage.getItem("users");
      users = storedUsers ? JSON.parse(storedUsers) : [];
      
      const tbody = document.getElementById("usersTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      
      users.forEach(user => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${user.fullName}</td>
          <td>${user.username}</td>
          <td>${user.role}</td>
          <td>
            ${user.role !== "admin" ? `<button class="btn btn-danger" onclick="promptDeleteUser('${user.username}')">Delete</button>` : ''}
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function promptDeleteUser(username) {
      userToDelete = username;
      showModal('deleteUserModal');
    }
    
    function confirmDeleteUser() {
      if (!userToDelete) return;
      
      // Remove user
      users = users.filter(u => u.username !== userToDelete);
      localStorage.setItem("users", JSON.stringify(users));
      
      // Remove user's attempts
      attempts = attempts.filter(a => a.username !== userToDelete);
      localStorage.setItem("attempts", JSON.stringify(attempts));
      
      alert("User deleted successfully!");
      closeModal('deleteUserModal');
      loadUsersList();
      loadAdminDashboard();
    }
    
    function addAdminUser() {
      const fullName = document.getElementById("newAdminFullName").value.trim();
      const username = document.getElementById("newAdminUsername").value.trim();
      const password = document.getElementById("newAdminPassword").value.trim();
      
      if (!fullName || !username || !password) {
        alert("Please fill in all fields");
        return;
      }
      
      if (users.some(u => u.username === username)) {
        alert("Username already exists. Please choose another username.");
        return;
      }
      
      users.push({
        fullName: fullName,
        username: username,
        password: password,
        role: "admin"
      });
      
      localStorage.setItem("users", JSON.stringify(users));
      alert("Admin user added successfully!");
      
      document.getElementById("newAdminFullName").value = "";
      document.getElementById("newAdminUsername").value = "";
      document.getElementById("newAdminPassword").value = "";
      
      loadUsersList();
    }
    
    function loadUserAttemptsSelect() {
      const select = document.getElementById("userAttemptsSelect");
      select.innerHTML = "<option value=''>Select a User</option>";
      
      const storedUsers = localStorage.getItem("users");
      users = storedUsers ? JSON.parse(storedUsers) : [];
      
      // Filter non-admin users
      const regularUsers = users.filter(u => u.role !== "admin");
      
      regularUsers.forEach(user => {
        const option = document.createElement("option");
        option.value = user.username;
        option.text = `${user.fullName} (${user.username})`;
        select.appendChild(option);
      });
      
      document.getElementById("userAttemptsTable").classList.add("hidden");
      document.getElementById("noAttemptsMessage").classList.remove("hidden");
    }
    
    function loadAttemptsForUser() {
      const selectedUsername = document.getElementById("userAttemptsSelect").value;
      const table = document.getElementById("userAttemptsTable");
      const tbody = table.getElementsByTagName("tbody")[0];
      const noAttemptsMsg = document.getElementById("noAttemptsMessage");
      
      tbody.innerHTML = "";
      
      if (!selectedUsername) {
        table.classList.add("hidden");
        noAttemptsMsg.classList.remove("hidden");
        noAttemptsMsg.innerText = "Select a user to view their attempts.";
        return;
      }
      
      // Filter attempts for selected user
      const userAttempts = attempts.filter(a => a.username === selectedUsername);
      
      if (userAttempts.length === 0) {
        table.classList.add("hidden");
        noAttemptsMsg.classList.remove("hidden");
        noAttemptsMsg.innerText = "No attempts found for this user.";
        return;
      }
      
      table.classList.remove("hidden");
      noAttemptsMsg.classList.add("hidden");
      
      // Sort by date (most recent first)
      userAttempts.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      userAttempts.forEach(attempt => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>Paper ${attempt.paper}</td>
          <td>${attempt.score} / ${attempt.total} (${(attempt.score/attempt.total*100).toFixed(2)}%)</td>
          <td>${new Date(attempt.date).toLocaleString()}</td>
          <td>
            <button class="btn btn-primary" onclick="viewUserAttempt('${attempt.id}')">View Details</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function viewUserAttempt(attemptId) {
      const attempt = attempts.find(a => a.id === attemptId);
      if (!attempt) return;
      
      const container = document.getElementById("attemptDetailsContainer");
      container.innerHTML = "";
      
      // Create attempt header
      const header = document.createElement("div");
      header.innerHTML = `
        <p><strong>Name:</strong> ${attempt.name}</p>
        <p><strong>Paper:</strong> Paper ${attempt.paper}</p>
        <p><strong>Date:</strong> ${new Date(attempt.date).toLocaleString()}</p>
        <p><strong>Score:</strong> ${attempt.score} / ${attempt.total} (${(attempt.score/attempt.total*100).toFixed(2)}%)</p>
      `;
      container.appendChild(header);
      
      // Create attempt details table
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.marginTop = "20px";
      
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Question No.</th>
          <th>Question</th>
          <th>Correct Answer</th>
          <th>User's Answer</th>
        </tr>
      `;
      table.appendChild(thead);
      
      const tbody = document.createElement("tbody");
      attempt.details.forEach(detail => {
        const isCorrect = detail.user === detail.correct;
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${detail.question}</td>
          <td>${detail.questionText}</td>
          <td>${detail.correct}</td>
          <td style="color: ${isCorrect ? '#4CAF50' : '#f44336'}">${detail.user}</td>
        `;
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
      
      showModal("viewUserAttemptModal");
    }
    
    // Data Management Functions
    function deleteAllUserData() {
      // Keep only admin users
      users = users.filter(user => user.role === "admin");
      localStorage.setItem("users", JSON.stringify(users));
      
      // Clear all attempts
      attempts = [];
      localStorage.setItem("attempts", JSON.stringify(attempts));
      
      alert("All attempts cleared successfully!");
      closeModal('resetAttemptsModal');
      loadAdminDashboard();
    }
    
    function resetPapers() {
      // Remove all papers
      papers = [];
      for(let i = 1; i <= defaultTotalPapers; i++) {
        // For paper 35, set only 35 questions, others get 100
        const questionCount = i === 35 ? 35 : 100;
        
        papers.push({ 
          paperNo: i, 
          questionCount: questionCount,
          questions: generateRandomQuestions(questionCount),
          timeLimit: 105 * 60 // 1 hour 45 minutes in seconds
        });
        
        // Generate and save random answer key
        const answerKey = generateRandomAnswerKey(questionCount);
        localStorage.setItem("key_paper_" + i, answerKey);
      }
      localStorage.setItem("papers", JSON.stringify(papers));
      
      // Remove attempts as well
      localStorage.removeItem("attempts");
      
      closeModal('resetPapersModal');
      alert("All papers have been reset to default");
      loadAdminDashboard();
      loadPapersList();
      loadUserAttemptsSelect();
    }
    
    function factoryReset() {
      // Keep only default admin user
      users = [{
        fullName: "Admin User",
        username: defaultAdminUsername,
        password: defaultAdminPassword,
        role: "admin"
      }];
      localStorage.setItem("users", JSON.stringify(users));
      
      // Reset papers
      resetPapers();
      
      alert("Factory reset completed successfully!");
      closeModal('factoryResetModal');
      
      // If the current user is not the default admin, log them out
      if (currentUser && currentUser.username !== defaultAdminUsername) {
        logout();
      } else {
        loadAdminDashboard();
        showAdminSection('adminDashboard');
      }
    }
    
    // Export Data Functions
    function exportUserData() {
      const usersData = JSON.stringify(users, null, 2);
      downloadData("users_data.json", usersData);
    }
    
    function exportAttemptData() {
      const attemptsData = JSON.stringify(attempts, null, 2);
      downloadData("attempts_data.json", attemptsData);
    }
    
    function exportPaperData() {
      const papersData = JSON.stringify(papers, null, 2);
      downloadData("papers_data.json", papersData);
    }
    
    function downloadData(filename, data) {
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Utility Functions
    function showModal(modalId) {
      document.getElementById(modalId).style.display = "block";
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }
    
    function generateUID() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // Handle local storage import/export functionality
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            showImportOptionsModal(importedData);
          } catch (error) {
            alert('Invalid JSON file: ' + error.message);
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    function showImportOptionsModal(data) {
      // Create a modal for import options
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      
      modalContent.innerHTML = `
        <span class="close" onclick="this.parentNode.parentNode.remove()">&times;</span>
        <h2>Import Data Options</h2>
        <p>Select what you want to import:</p>
        <div>
          ${data.users ? `<button class="btn btn-primary" onclick="importUsers(${JSON.stringify(data.users).replace(/"/g, '&quot;')}); this.parentNode.parentNode.parentNode.remove()">Import Users</button>` : ''}
          ${data.papers ? `<button class="btn btn-primary" onclick="importPapers(${JSON.stringify(data.papers).replace(/"/g, '&quot;')}); this.parentNode.parentNode.parentNode.remove()">Import Papers</button>` : ''}
          ${data.attempts ? `<button class="btn btn-primary" onclick="importAttempts(${JSON.stringify(data.attempts).replace(/"/g, '&quot;')}); this.parentNode.parentNode.parentNode.remove()">Import Attempts</button>` : ''}
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }
    
    function importUsers(importedUsers) {
      if (confirm('This will replace all existing users. Continue?')) {
        users = importedUsers;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Users imported successfully!');
        loadUsersList();
        loadAdminDashboard();
      }
    }
    
    function importPapers(importedPapers) {
      if (confirm('This will replace all existing papers. Continue?')) {
        papers = importedPapers;
        localStorage.setItem('papers', JSON.stringify(papers));
        alert('Papers imported successfully!');
        loadPapersList();
        loadAdminDashboard();
      }
    }
    
    function importAttempts(importedAttempts) {
      if (confirm('This will replace all existing attempts. Continue?')) {
        attempts = importedAttempts;
        localStorage.setItem('attempts', JSON.stringify(attempts));
        alert('Attempts imported successfully!');
        loadAdminDashboard();
      }
    }
    
    // Handle theme switching
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('light-mode');
      
      const isDarkMode = !body.classList.contains('light-mode');
      localStorage.setItem('darkMode', isDarkMode);
      
      // Update button text
      const toggleBtn = document.getElementById('toggleThemeBtn');
      if (toggleBtn) {
        toggleBtn.innerText = isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode';
      }
    }

    // Check user's preferred theme on load
    function checkPreferredTheme() {
      const prefersDarkMode = localStorage.getItem('darkMode') !== 'false';
      
      if (!prefersDarkMode) {
        document.body.classList.add('light-mode');
      }
      
      // Update button text
      const toggleBtn = document.getElementById('toggleThemeBtn');
      if (toggleBtn) {
        toggleBtn.innerText = prefersDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode';
      }
    }
    
    // Call theme check after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      checkPreferredTheme();
    });
    
    // Add print functionality for result reports
    function printResults() {
      const printWindow = window.open('', '_blank');
      
      const resultTableHtml = document.getElementById('resultTable').outerHTML;
      const scoreDisplayHtml = document.getElementById('scoreDisplay').innerText;
      const paperTitle = document.getElementById('testPaperTitle').innerText;
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${paperTitle} - Results</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1, h2 { text-align: center; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
            th { background-color: #f2f2f2; }
          </style>
        </head>
        <body>
          <h1>${paperTitle}</h1>
          <h2>${scoreDisplayHtml}</h2>
          <h3>Test taken by: ${currentUser.fullName}</h3>
          <h3>Date: ${new Date().toLocaleString()}</h3>
          ${resultTableHtml}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    }
  </script>
</body>
</html>